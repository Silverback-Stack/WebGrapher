Setup Azure Active Directory
============================

From Azure Portal -> Active Directory

Select Add -> App registration

  Name: WebGrapher

  Supported account type: Accounts in this organizational directory only (Default Directory only - Single tenant)

  Redirect Url
  
	Platform: Single page application

	Address: https://orange-sand-018f7a303.3.azurestaticapps.net/callback

Click Register

From the WebGrapher -> Overview make a note of:

  Directory (Tenant) ID

  Application (Client) ID


Click the WebGrapher App Registration to open settings

Choose Expose an API

Click Add a scope

Accept the auto generated Application Id

Click Save

From the settings:

  Scope name: access_as_user

  Consent: Admins and users

  Admin consent display name: Access the WebGrapher API as a user

  Admin consent description: Allows the app to access the WebGrapher API on behalf of the signed-in user.

  User consent display name: Access the WebGrapher API

  User consent description: This app will be able to call the WebGrapher API with your permissions.

  State: Enabled

Click Add Scope

Click Add a client applciation

	Client Id: Paste the Application (Client) ID created above

	Tick Authorised scopes: access_as_user

Click Add Applications


From the top of page, make a note of

  Application ID Uri (Audience)

  Scope Url




Enable Access tokens
====================

From Manage -> Authentication (Preview)

Tick: Access tokens (used for implicit and hybrid flows)

Click Save



Configure Access Token Version
==============================

From Manage -> Manifest

Find value requestedAccessTokenVersion and set to ...

  "requestedAccessTokenVersion": 2,

Click Save 

This will send the newest version (V2 instead V1) of tokens of to our application.



Setup Idenity Provider
======================

Open Visual Studio WebGrapher application

Expand src/Shared.Settings/Shared.Auth

Open appsettings.Production.json

Update values:

  Instance

  TenantId

  ClientId

  Audience

  Scope

  LoginUrl

  LoginOut



Deploy Worker Services
======================

Follow deployment instructions for worker services.


Configure Worker Service
========================

From Azure portal -> Worker Services -> graphingworkerservice-app 

Select Application -> Containers -> Environment variables

Edit or Create entry:

  Name: Auth__IdentityProvider__ProviderType
  Source: Manual entry
  Value: AzureAD

Save as a new revision


Repeate above steps for: streamingworkerservice-app 

Save as a new revision






